---
// EventCalendar.astro - Google Calendar style event calendar
import { API_BASE_URL } from "../config";

const token = Astro.cookies.get("token")?.value;

let events: any[] = [];
try {
    const response = await fetch(`${API_BASE_URL}/api/event`, {
        headers: token
            ? {
                  Authorization: `Bearer ${token}`,
              }
            : {},
    });
    if (response.ok) {
        const data = await response.json();
        events = data.events || [];
    }
} catch (error) {
    console.error("Failed to fetch events:", error);
}
---

<style>
    @keyframes toast-enter {
        from {
            opacity: 0;
            transform: translateX(400px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes toast-exit {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(400px);
        }
    }

    .toast-enter {
        animation: toast-enter 0.3s ease-out forwards;
    }

    .toast-exit {
        animation: toast-exit 0.3s ease-in forwards;
    }
</style>

<div class="bg-white shadow-lg border border-gray-200 h-full">
    <!-- Calendar Header -->
    <div class="border-b border-gray-200 p-4 bg-gray-50">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
                <h2 class="text-2xl font-black text-gray-900">
                    <span id="current-month">December</span>
                    <span id="current-year">2025</span>
                </h2>
            </div>
            <div class="flex items-center gap-2">
                <button
                    id="prev-month"
                    class="px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors font-semibold text-gray-700"
                >
                    ‚Äπ Prev
                </button>
                <button
                    id="today-btn"
                    class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 transition-colors font-semibold"
                >
                    Today
                </button>
                <button
                    id="next-month"
                    class="px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors font-semibold text-gray-700"
                >
                    Next ‚Ä∫
                </button>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="flex gap-2">
            <button
                class="view-toggle active px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 transition-colors font-semibold"
                data-view="month"
            >
                Month
            </button>
            <button
                class="view-toggle px-4 py-2 bg-white border border-gray-300 hover:bg-blue-500 transition-colors font-semibold text-gray-700"
                data-view="week"
            >
                Week
            </button>
            <button
                class="view-toggle px-4 py-2 bg-white border border-gray-300 hover:bg-blue-500 transition-colors font-semibold text-gray-700"
                data-view="day"
            >
                Day
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div id="calendar-view" class="p-4">
        <!-- Day Names Header -->
        <div class="grid grid-cols-7 gap-px mb-px bg-gray-200">
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                SUN
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                MON
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                TUE
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                WED
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                THU
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                FRI
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                SAT
            </div>
        </div>

        <!-- Calendar Days Grid -->
        <div
            id="calendar-days"
            class="grid grid-cols-7 gap-px bg-gray-200 min-h-[600px]"
        >
            <!-- Days will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Event Modal -->
<div
    id="event-modal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm"
>
    <div
        class="bg-white w-full max-w-2xl border-4 border-black shadow-[12px_12px_0px_0px_rgba(0,0,0,1)]"
    >
        <div
            class="bg-black text-white p-6 flex justify-between items-center border-b-4 border-black"
        >
            <h3
                class="text-2xl font-black uppercase tracking-tight"
                style="font-family: 'Poppins', sans-serif;"
            >
                Event Details
            </h3>
            <button
                id="close-modal"
                class="text-white hover:text-gray-300 text-3xl font-black leading-none"
                >√ó</button
            >
        </div>
        <div id="modal-content" class="p-8">
            <!-- Event details will be populated here -->
        </div>
    </div>
</div>

<!-- Toast Container -->
<div
    id="calendar-toast-container"
    class="fixed top-4 right-4 z-[60] flex flex-col gap-2"
>
</div>

<script define:vars={{ events: events, API_BASE_URL: API_BASE_URL }}>
    // Transform events to calendar format
    const calendarEvents = events.map((event) => {
        const categoryColors = {
            Technology: "bg-blue-500",
            "Machine Learning/AI": "bg-purple-500",
            Cultural: "bg-pink-500",
            Gaming: "bg-green-500",
            Sports: "bg-orange-500",
            Cybersecurity: "bg-red-500",
            "Creative AI": "bg-indigo-500",
        };

        const startDate = new Date(event.startTime);
        const dateStr = startDate.toISOString().split("T")[0];
        const timeStr = startDate.toLocaleTimeString("en-US", {
            hour: "numeric",
            minute: "2-digit",
            hour12: true,
        });

        return {
            id: event.publicId,
            title: event.title,
            date: dateStr,
            time: timeStr,
            location: event.venue,
            description: event.description,
            category: event.category,
            color: categoryColors[event.category] || "bg-gray-500",
        };
    });

    let currentDate = new Date();
    let currentView = "month";

    function getWeekDates(date) {
        const week = [];
        const current = new Date(date);
        const day = current.getDay();
        const diff = current.getDate() - day;

        for (let i = 0; i < 7; i++) {
            const weekDate = new Date(current);
            weekDate.setDate(diff + i);
            week.push(weekDate);
        }
        return week;
    }

    function formatDateStr(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    function renderCalendar() {
        if (currentView === "month") {
            renderMonthView();
        } else if (currentView === "week") {
            renderWeekView();
        } else if (currentView === "day") {
            renderDayView();
        }
    }

    function renderMonthView() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Update header
        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];
        const monthElement = document.getElementById("current-month");
        const yearElement = document.getElementById("current-year");
        if (monthElement) {
            monthElement.textContent = monthNames[month];
        }
        if (yearElement) {
            yearElement.textContent = year.toString();
        }

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const calendarDays = document.getElementById("calendar-days");
        if (!calendarDays) return;
        calendarDays.className =
            "grid grid-cols-7 gap-px bg-gray-200 min-h-[600px]";
        calendarDays.innerHTML = "";

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            const dayDiv = createDayCell(
                daysInPrevMonth - i,
                true,
                year,
                month - 1,
            );
            calendarDays.appendChild(dayDiv);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = createDayCell(day, false, year, month);
            calendarDays.appendChild(dayDiv);
        }

        // Next month days to complete the grid
        const totalCells = firstDay + daysInMonth;
        const weeksNeeded = Math.ceil(totalCells / 7);
        const remainingCells = weeksNeeded * 7 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
            const dayDiv = createDayCell(day, true, year, month + 1);
            calendarDays.appendChild(dayDiv);
        }
    }

    function renderWeekView() {
        const weekDates = getWeekDates(currentDate);
        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];

        // Update header
        const monthElement = document.getElementById("current-month");
        const yearElement = document.getElementById("current-year");
        if (monthElement) {
            const startMonth = monthNames[weekDates[0].getMonth()];
            const endMonth = monthNames[weekDates[6].getMonth()];
            monthElement.textContent =
                startMonth === endMonth
                    ? startMonth
                    : `${startMonth} - ${endMonth}`;
        }
        if (yearElement) {
            yearElement.textContent = weekDates[0].getFullYear().toString();
        }

        const calendarDays = document.getElementById("calendar-days");
        if (!calendarDays) return;
        calendarDays.className =
            "grid grid-cols-[80px_repeat(7,1fr)] gap-px bg-gray-200 min-h-[600px]";
        calendarDays.innerHTML = "";

        const hours = Array.from({ length: 17 }, (_, i) => i + 6); // 6 AM to 10 PM

        // Header row with dates
        const headerTime = document.createElement("div");
        headerTime.className =
            "bg-gray-50 p-2 text-center font-bold text-gray-700 text-xs border-r-2 border-gray-300";
        headerTime.textContent = "";
        calendarDays.appendChild(headerTime);

        weekDates.forEach((date) => {
            const headerDiv = document.createElement("div");
            const isToday = formatDateStr(date) === formatDateStr(new Date());
            headerDiv.className = `bg-gray-50 p-2 text-center font-bold text-gray-700 text-sm ${isToday ? "bg-blue-100" : ""}`;
            headerDiv.innerHTML = `
                <div class="text-xs">${["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][date.getDay()]}</div>
                <div class="text-lg ${isToday ? "text-blue-600" : ""}">${date.getDate()}</div>
            `;
            calendarDays.appendChild(headerDiv);
        });

        // Time slots
        hours.forEach((hour) => {
            // Time label
            const timeLabel = document.createElement("div");
            timeLabel.className =
                "bg-gray-50 p-2 text-right text-xs text-gray-600 font-semibold border-r-2 border-gray-300";
            timeLabel.textContent = `${hour > 12 ? hour - 12 : hour}:00 ${hour >= 12 ? "PM" : "AM"}`;
            calendarDays.appendChild(timeLabel);

            // Day cells
            weekDates.forEach((date) => {
                const cellDiv = document.createElement("div");
                cellDiv.className =
                    "bg-white p-1 min-h-[60px] hover:bg-gray-50 transition-colors relative";

                const dateStr = formatDateStr(date);
                const dayEvents = calendarEvents.filter((event) => {
                    if (event.date !== dateStr) return false;
                    const eventHour = parseInt(event.time.split(":")[0]);
                    const isPM = event.time.includes("PM");
                    const eventHour24 =
                        isPM && eventHour !== 12 ? eventHour + 12 : eventHour;
                    return eventHour24 === hour;
                });

                dayEvents.forEach((event) => {
                    const eventDiv = document.createElement("div");
                    eventDiv.className = `${event.color} text-white text-xs p-1 mb-1 cursor-pointer hover:opacity-80 transition-opacity rounded`;
                    eventDiv.textContent = event.title;
                    eventDiv.onclick = () => showEventModal(event);
                    cellDiv.appendChild(eventDiv);
                });

                calendarDays.appendChild(cellDiv);
            });
        });
    }

    function renderDayView() {
        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];

        // Update header
        const monthElement = document.getElementById("current-month");
        const yearElement = document.getElementById("current-year");
        if (monthElement) {
            monthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}`;
        }
        if (yearElement) {
            yearElement.textContent = currentDate.getFullYear().toString();
        }

        const calendarDays = document.getElementById("calendar-days");
        if (!calendarDays) return;
        calendarDays.className =
            "grid grid-cols-[100px_1fr] gap-px bg-gray-200 min-h-[600px]";
        calendarDays.innerHTML = "";

        const hours = Array.from({ length: 17 }, (_, i) => i + 6); // 6 AM to 10 PM
        const dateStr = formatDateStr(currentDate);

        hours.forEach((hour) => {
            // Time label
            const timeLabel = document.createElement("div");
            timeLabel.className =
                "bg-gray-50 p-3 text-right text-sm text-gray-700 font-bold border-r-2 border-gray-300";
            const displayHour = hour > 12 ? hour - 12 : hour;
            const period = hour >= 12 ? "PM" : "AM";
            timeLabel.textContent = `${displayHour}:00 ${period}`;
            calendarDays.appendChild(timeLabel);

            // Time slot
            const cellDiv = document.createElement("div");
            cellDiv.className =
                "bg-white p-3 min-h-[80px] hover:bg-gray-50 transition-colors";

            const dayEvents = calendarEvents.filter((event) => {
                if (event.date !== dateStr) return false;
                const eventHour = parseInt(event.time.split(":")[0]);
                const isPM = event.time.includes("PM");
                const eventHour24 =
                    isPM && eventHour !== 12 ? eventHour + 12 : eventHour;
                return eventHour24 === hour;
            });

            dayEvents.forEach((event) => {
                const eventDiv = document.createElement("div");
                eventDiv.className = `${event.color} text-white p-3 mb-2 cursor-pointer hover:opacity-90 transition-opacity rounded shadow-lg`;
                eventDiv.innerHTML = `
                    <div class="font-bold">${event.title}</div>
                    <div class="text-sm mt-1">${event.time}</div>
                    <div class="text-xs mt-1">${event.location}</div>
                `;
                eventDiv.onclick = () => showEventModal(event);
                cellDiv.appendChild(eventDiv);
            });

            calendarDays.appendChild(cellDiv);
        });
    }

    function createDayCell(day, isOtherMonth, year, month) {
        const dayDiv = document.createElement("div");
        dayDiv.className = `bg-white p-2 min-h-[100px] border-gray-200 hover:bg-gray-50 transition-colors ${isOtherMonth ? "text-gray-400" : "text-gray-900"}`;

        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const today = new Date();
        const isToday =
            dateStr ===
            `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

        const dayNumber = document.createElement("div");
        dayNumber.className = `text-sm font-bold mb-1 ${isToday ? "bg-blue-600 text-white w-7 h-7 flex items-center justify-center" : ""}`;
        dayNumber.style.fontFamily = "'Poppins', sans-serif";
        dayNumber.textContent = day;
        dayDiv.appendChild(dayNumber);

        // Add events for this day
        const dayEvents = calendarEvents.filter(
            (event) => event.date === dateStr,
        );
        dayEvents.forEach((event) => {
            const eventDiv = document.createElement("div");
            eventDiv.className = `${event.color} text-white text-xs p-1 mb-1 cursor-pointer hover:opacity-80 transition-opacity`;
            eventDiv.textContent = event.title;
            eventDiv.onclick = () => showEventModal(event);
            dayDiv.appendChild(eventDiv);
        });

        return dayDiv;
    }

    async function showEventModal(event) {
        const modal = document.getElementById("event-modal");
        const modalContent = document.getElementById("modal-content");

        if (!modalContent || !modal) return;

        // Check registration status
        let isRegistered = false;
        try {
            const response = await fetch(
                `${API_BASE_URL}/api/registration/status/${event.id}`,
                {
                    credentials: "include",
                },
            );

            if (response.ok) {
                const result = await response.json();
                isRegistered = result.isRegistered;
            }
        } catch (error) {
            console.error("Error checking registration:", error);
        }

        const registerBtnHTML = isRegistered
            ? `<button class="w-full py-4 px-6 bg-green-600 border-2 border-black text-white font-black uppercase tracking-wider cursor-not-allowed shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]" disabled>‚úì Already Registered</button>`
            : `<button onclick="handleRegister('${event.id}')" class="w-full py-4 px-6 bg-black border-2 border-black text-white font-black uppercase tracking-wider hover:bg-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[2px] transition-all">Register Now</button>`;

        modalContent.innerHTML = `
      <div class="space-y-6">
        <div class="border-b-2 border-black pb-4">
          <h4 class="text-3xl font-black text-gray-900 mb-3 uppercase tracking-tight" style="font-family: 'Poppins', sans-serif;">${event.title}</h4>
          <span class="inline-block px-4 py-2 ${event.color} text-white text-sm font-black uppercase border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">${event.category}</span>
        </div>
        <div class="space-y-3 bg-gray-50 p-6 border-2 border-black">
          <p class="text-gray-900 font-bold"><span class="font-black uppercase text-sm tracking-wide">üìÖ Date:</span> ${new Date(event.date).toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" })}</p>
          <p class="text-gray-900 font-bold"><span class="font-black uppercase text-sm tracking-wide">‚è∞ Time:</span> ${event.time}</p>
          <p class="text-gray-900 font-bold"><span class="font-black uppercase text-sm tracking-wide">üìç Location:</span> ${event.location}</p>
        </div>
        <div>
          <p class="text-gray-900 font-black uppercase text-sm tracking-wide mb-2">Description:</p>
          <p class="text-gray-700 font-medium leading-relaxed">${event.description || "No description available."}</p>
        </div>
        <div class="pt-4 border-t-2 border-black">
          ${registerBtnHTML}
        </div>
      </div>
    `;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function showToast(message, type = "success") {
        const container = document.getElementById("calendar-toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        const bgColor = type === "success" ? "bg-green-600" : "bg-red-600";
        toast.className = `${bgColor} text-white px-6 py-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-bold flex items-center gap-3 min-w-[300px] toast-enter`;

        toast.innerHTML = `
            <span class="flex-1">${message}</span>
            <button class="hover:text-gray-200" onclick="this.parentElement.remove()">‚úï</button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove("toast-enter");
            toast.classList.add("toast-exit");
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    window.handleRegister = async function (eventId) {
        if (!eventId) {
            showToast("Invalid event", "error");
            return;
        }

        try {
            const response = await fetch(
                `${API_BASE_URL}/api/registration/register`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    credentials: "include",
                    body: JSON.stringify({ eventId }),
                },
            );

            const result = await response.json();

            if (response.ok) {
                // Close modal
                const modal = document.getElementById("event-modal");
                if (modal) {
                    modal.classList.add("hidden");
                    modal.classList.remove("flex");
                }

                showToast("Successfully registered for the event!", "success");

                // Reload to update calendar
                setTimeout(() => window.location.reload(), 1500);
            } else {
                if (response.status === 401) {
                    showToast(
                        "Please login to register for this event",
                        "error",
                    );
                    setTimeout(() => (window.location.href = "/login"), 1500);
                } else {
                    showToast(result.message || "Registration failed", "error");
                }
            }
        } catch (error) {
            console.error("Registration error:", error);
            showToast("An error occurred. Please try again.", "error");
        }
    };

    // Event listeners
    document.getElementById("prev-month")?.addEventListener("click", () => {
        if (currentView === "month") {
            currentDate.setMonth(currentDate.getMonth() - 1);
        } else if (currentView === "week") {
            currentDate.setDate(currentDate.getDate() - 7);
        } else if (currentView === "day") {
            currentDate.setDate(currentDate.getDate() - 1);
        }
        renderCalendar();
    });

    document.getElementById("next-month")?.addEventListener("click", () => {
        if (currentView === "month") {
            currentDate.setMonth(currentDate.getMonth() + 1);
        } else if (currentView === "week") {
            currentDate.setDate(currentDate.getDate() + 7);
        } else if (currentView === "day") {
            currentDate.setDate(currentDate.getDate() + 1);
        }
        renderCalendar();
    });

    document.getElementById("today-btn")?.addEventListener("click", () => {
        currentDate = new Date();
        renderCalendar();
    });

    document.getElementById("close-modal")?.addEventListener("click", () => {
        const modal = document.getElementById("event-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    });

    // View toggle buttons
    document.querySelectorAll(".view-toggle").forEach((btn) => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".view-toggle").forEach((b) => {
                b.classList.remove("active", "bg-blue-600", "text-white");
                b.classList.add(
                    "bg-white",
                    "border",
                    "border-gray-300",
                    "text-gray-700",
                );
            });
            btn.classList.add("active", "bg-blue-600", "text-white");
            btn.classList.remove(
                "bg-white",
                "border",
                "border-gray-300",
                "text-gray-700",
            );
            currentView = btn.dataset.view || "month";
            renderCalendar();
        });
    });

    // Initial render
    renderCalendar();
</script>
