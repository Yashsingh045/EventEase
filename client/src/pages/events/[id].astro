---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import Navbar from "../../components/Navbar.astro";
import { API_BASE_URL } from "../../config.js";
import ToastContainer from "../../components/dashboard/ToastContainer.astro";

const { id } = Astro.params;

let event: any = null;
let error: string | null = null;

try {
  const response = await fetch(`${API_BASE_URL}/api/event/${id}`);
  if (!response.ok) {
    throw new Error("Failed to fetch event");
  }
  const data = await response.json();
  event = data.event;
} catch (e) {
  console.error("Error fetching event:", e);
  error = "Could not load event details.";
}

if (!event && !error) {
    return Astro.redirect('/404');
}


let userReview = null;
let publicReviews = [];
let averageRating = 0;
let totalReviews = 0;

try {
  const reviewResponse = await fetch(`${API_BASE_URL}/api/reviews/event/${id}/user-review`, {
    credentials: "include",
  });
  if (reviewResponse.ok) {
    userReview = await reviewResponse.json();
  }

  const allReviewsResponse = await fetch(`${API_BASE_URL}/api/reviews/event/${id}`);
  if (allReviewsResponse.ok) {
    const data = await allReviewsResponse.json();
    publicReviews = data.reviews || [];
    averageRating = data.averageRating || 0;
    totalReviews = data.totalReviews || 0;
  }
} catch (error) {
  console.error("Error fetching reviews:", error);
}
---

<Layout title={event ? `${event.title} | EventEase` : "Event Not Found"}>
    <Navbar />
    
    {error ? (
        <div class="min-h-screen flex items-center justify-center bg-gray-50">
            <div class="text-center p-8 border-4 border-black bg-white shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                <h1 class="text-3xl font-black text-gray-900 mb-4 uppercase tracking-tight" style="font-family: 'Space Grotesk', sans-serif;">Error Loading Event</h1>
                <p class="text-gray-700 mb-6 font-bold">{error}</p>
                <a href="/exploreEvents" class="btn btn-primary border-2 border-black bg-black text-white hover:bg-gray-800 rounded-none uppercase font-black tracking-wider shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[2px] transition-all">Back to Events</a>
            </div>
        </div>
    ) : (
        <div class="min-h-screen bg-gray-50 font-sans pb-20">
            <!-- Hero Section -->
            <div class="relative h-[400px] flex items-center justify-center overflow-hidden border-b-4 border-black bg-blue-600">
                <img
                    src={event.posterUrl || "https://images.unsplash.com/photo-1540575467063-178a50c2df87?auto=format&fit=crop&q=80&w=2070"}
                    alt={event.title}
                    class="w-full h-full object-cover opacity-60 grayscale mix-blend-multiply"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-16 z-10">
                    <div class="max-w-6xl mx-auto">
                        <span class="inline-block bg-blue-600 text-white border-2 border-white px-4 py-1 mb-4 text-sm font-black uppercase tracking-wider shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                            {event.category}
                        </span>
                        <h1 class="text-5xl md:text-7xl font-black text-white mb-4 uppercase tracking-tighter leading-none" style="font-family: 'Space Grotesk', sans-serif;">
                            {event.title}
                        </h1>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-10 max-w-6xl mx-auto -mt-10 px-5 md:px-10 relative z-20">
                <div class="bg-white border-4 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)]">
                    <div class="flex items-center gap-4 mb-8 border-b-4 border-black pb-6">
                        <div class="flex-1">
                            <p class="text-sm font-black text-gray-500 uppercase tracking-wider mb-1">Organized By</p>
                            <p class="text-xl font-bold text-gray-900">{event.organizer?.name || "Event Organizer"}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-gray-500 uppercase tracking-wider mb-1">Price</p>
                            <p class="text-3xl font-black text-blue-600">{event.price === 0 ? "FREE" : `$${event.price}`}</p>
                        </div>
                    </div>

                    <h2 class="text-2xl font-black mb-4 text-gray-900 uppercase tracking-tight border-l-8 border-blue-600 pl-4" style="font-family: 'Space Grotesk', sans-serif;">
                        About This Event
                    </h2>
                    <p class="text-lg text-gray-800 mb-8 leading-relaxed font-medium">
                        {event.description}
                    </p>
                    
                    {event.longDescription && (
                         <div class="mb-8">
                            <p class="text-gray-700 leading-relaxed whitespace-pre-line">
                                {event.longDescription}
                            </p>
                        </div>
                    )}

                    <div class="bg-gray-100 border-2 border-black p-6 mb-8">
                        <h3 class="text-xl font-black mb-4 text-gray-900 uppercase tracking-tight flex items-center gap-2">
                            <span class="text-2xl">üèÜ</span> Prize Pool
                        </h3>
                        <p class="text-gray-800 font-bold text-lg">
                            {event.prizePool ? (event.prizeDescription || `Total prize pool of ‚Çπ${event.prizePool}`) : "No monetary prizes for this event, but participants gain valuable networking opportunities and exposure."}
                        </p>
                    </div>

                    <button
                        class="btn btn-primary w-full py-4 text-xl border-2 border-black bg-black text-white hover:bg-gray-800 rounded-none uppercase font-black tracking-wider shadow-[8px_8px_0px_0px_rgba(0,0,0,0.2)] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[4px] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none"
                        id="joinEventBtn"
                        data-event-id={id}>Join Event Now</button>
                    
                </div>

                <!-- Sidebar -->
                <aside class="flex flex-col gap-6">
                    <div class="bg-white border-4 border-black p-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                        <h3 class="text-xl font-black mb-6 text-gray-900 uppercase tracking-tight border-b-4 border-black pb-2" style="font-family: 'Space Grotesk', sans-serif;">
                            Event Details
                        </h3>
                        
                        <div class="space-y-6">
                            <div class="flex items-start gap-4">
                                <div class="bg-blue-100 p-2 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </div>
                                <div>
                                    <p class="text-xs font-black text-gray-500 uppercase tracking-wider">Date</p>
                                    <p class="font-bold text-gray-900">{new Date(event.startTime).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-4">
                                <div class="bg-green-100 p-2 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-xs font-black text-gray-500 uppercase tracking-wider">Time</p>
                                    <p class="font-bold text-gray-900">{new Date(event.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - {new Date(event.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-4">
                                <div class="bg-purple-100 p-2 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-xs font-black text-gray-500 uppercase tracking-wider">Location</p>
                                    <p class="font-bold text-gray-900">{event.venue}</p>
                                    <p class="text-xs font-bold text-blue-600 mt-1 uppercase">{event.venue?.toLowerCase().includes("online") ? "Online Event" : "In-Person Event"}</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-4">
                                <div class="bg-yellow-100 p-2 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-xs font-black text-gray-500 uppercase tracking-wider">Capacity</p>
                                    <p class="font-bold text-gray-900">{event.capacity?.toLocaleString() || "Unlimited"}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border-4 border-black p-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                        <h3 class="text-xl font-black mb-4 text-gray-900 uppercase tracking-tight border-b-4 border-black pb-2" style="font-family: 'Space Grotesk', sans-serif;">
                            Tags
                        </h3>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="bg-white border-2 border-black text-black font-bold px-3 py-1 text-sm shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] uppercase tracking-wide">
                                {event.category}
                            </span>
                            <span class="bg-white border-2 border-black text-black font-bold px-3 py-1 text-sm shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] uppercase tracking-wide">
                                Event
                            </span>
                        </div>
                    </div>
                </aside>
            </div>

            <!-- Reviews Section -->
            <section class="mt-16 max-w-3xl mx-auto px-4">
                <div class="bg-white border-4 border-black p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)]">
                    <h2 class="text-3xl font-black text-gray-900 mb-8 flex items-center uppercase tracking-tight" style="font-family: 'Space Grotesk', sans-serif;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-black mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                        Leave a Review
                    </h2>

                    {userReview ? (
                        <div class="bg-yellow-50 border-2 border-black p-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-black" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-lg font-black text-gray-900 uppercase tracking-wide">Your Review</h3>
                                    <div class="mt-2 text-gray-800">
                                        <p class="flex items-center mb-2">
                                            <span class="font-bold uppercase text-sm mr-2">Rating:</span>
                                            <span class="flex">
                                                {Array.from({ length: 5 }).map((_, i) => (
                                                    <svg 
                                                        class={`h-5 w-5 ${i < userReview.rating ? 'text-black fill-current' : 'text-gray-300'}`} 
                                                        viewBox="0 0 20 20"
                                                        stroke="currentColor"
                                                        stroke-width="1"
                                                    >
                                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                    </svg>
                                                ))}
                                                <span class="ml-2 font-black">({userReview.rating}.0/5.0)</span>
                                            </span>
                                        </p>
                                        {userReview.feedback && (
                                            <p>
                                                <span class="font-bold uppercase text-sm mr-2">Feedback:</span>
                                                <span class="font-medium italic">"{userReview.feedback}"</span>
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <form id="reviewForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-black text-gray-900 mb-2 uppercase tracking-wide">
                                    How would you rate this event?
                                    <span class="text-red-600">*</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    {[1, 2, 3, 4, 5].map((rating) => (
                                        <div class="relative group">
                                            <input
                                                type="radio"
                                                id={`rating-${rating}`}
                                                name="rating"
                                                value={rating}
                                                class="sr-only"
                                                required
                                            />
                                            <label
                                                for={`rating-${rating}`}
                                                class="star-rating block w-10 h-10 cursor-pointer text-gray-300 hover:text-black transition-colors duration-200"
                                                data-rating={rating}
                                            >
                                                <svg
                                                    class="w-full h-full stroke-black stroke-2"
                                                    fill="currentColor"
                                                    viewBox="0 0 20 20"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                </svg>
                                            </label>
                                        </div>
                                    ))}
                                    <span id="rating-text" class="ml-4 text-lg font-black text-gray-400 uppercase tracking-wide">
                                        Select rating
                                    </span>
                                </div>
                            </div>

                            <div>
                                <label for="feedback" class="block text-sm font-black text-gray-900 mb-2 uppercase tracking-wide">
                                    Share your experience
                                    <span class="text-red-600">*</span>
                                </label>
                                <textarea
                                    id="feedback"
                                    name="feedback"
                                    rows="4"
                                    class="block w-full px-4 py-3 border-2 border-black bg-gray-50 focus:outline-none focus:ring-0 focus:border-blue-600 font-bold placeholder-gray-400 transition-colors"
                                    placeholder="What did you like or dislike about this event?"
                                    required
                                ></textarea>
                            </div>

                            <div class="pt-2">
                                <button
                                    type="submit"
                                    class="w-full flex justify-center py-4 px-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] text-sm font-black uppercase tracking-wider text-white bg-blue-600 hover:bg-blue-700 hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all duration-200 rounded-none"
                                >
                                    Submit Review
                                </button>
                            </div>
                        </form>
                    )}
                </div>
                </div>

                <div class="mt-16 max-w-4xl mx-auto px-4">
                    <div class="flex items-center justify-between mb-8 border-b-4 border-black pb-4">
                        <h3 class="text-3xl font-black text-gray-900 uppercase tracking-tight" style="font-family: 'Space Grotesk', sans-serif;">
                            Community Reviews
                        </h3>
                        <span class="bg-black text-white text-lg font-bold px-4 py-1 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                            {totalReviews} {totalReviews === 1 ? 'Review' : 'Reviews'}
                        </span>
                    </div>

                    {publicReviews.length > 0 ? (
                        <div class="grid gap-8">
                            {publicReviews.map((review) => (
                                <div class="bg-white border-4 border-black p-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] hover:shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 transition-all duration-200">
                                    <div class="flex items-start justify-between mb-6">
                                        <div class="flex items-center gap-4">
                                            <div class="avatar placeholder">
                                                <div class="bg-blue-600 text-white w-12 h-12 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] flex items-center justify-center font-black text-lg">
                                                    <span>{review.user.firstName[0]}{review.user.lastName[0]}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <p class="font-black text-gray-900 uppercase text-lg leading-none mb-1">{review.user.firstName} {review.user.lastName}</p>
                                                <p class="text-xs text-gray-500 font-bold font-mono">{new Date(review.createdAt).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                            </div>
                                        </div>
                                        <div class="flex bg-yellow-100 px-3 py-1 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                            {Array.from({ length: 5 }).map((_, i) => (
                                                <svg 
                                                    class={`h-5 w-5 ${i < review.rating ? 'text-black fill-current' : 'text-gray-300'}`} 
                                                    viewBox="0 0 20 20"
                                                    stroke="currentColor"
                                                    stroke-width="1.5"
                                                >
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                </svg>
                                            ))}
                                            <span class="ml-2 font-black text-sm">{review.rating}.0</span>
                                        </div>
                                    </div>
                                    {review.feedback && (
                                        <div class="relative">
                                            <svg class="absolute -top-3 -left-2 h-8 w-8 text-gray-200 transform -scale-x-100" fill="currentColor" viewBox="0 0 32 32" aria-hidden="true">
                                                <path d="M9.352 4C4.456 7.456 1 13.12 1 19.36c0 5.088 3.072 8.064 6.624 8.064 3.36 0 5.856-2.688 5.856-5.856 0-3.168-2.208-5.472-5.088-5.472-.576 0-1.344.096-1.536.192.48-3.264 3.552-7.104 6.624-9.024L9.352 4zm16.512 0c-4.8 3.456-8.256 9.12-8.256 15.36 0 5.088 3.072 8.064 6.624 8.064 3.264 0 5.856-2.688 5.856-5.856 0-3.168-2.304-5.472-5.184-5.472-.576 0-1.248.096-1.44.192.48-3.264 3.456-7.104 6.528-9.024L25.864 4z" />
                                            </svg>
                                            <p class="text-gray-800 font-medium text-lg italic pl-6 relative z-10 leading-relaxed">
                                                {review.feedback}
                                            </p>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div class="bg-gray-50 border-4 border-black border-dashed p-12 text-center">
                            <div class="inline-block bg-gray-200 rounded-full p-4 mb-4 border-2 border-black">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                            <p class="text-gray-900 text-xl font-black uppercase tracking-tight mb-2">No reviews yet</p>
                            <p class="text-gray-600 font-medium">Be the first to share your experience with this event!</p>
                        </div>
                    )}
                </div>
            </section>
        </div>
    )}

    <ToastContainer />
    <Footer />

    <script define:vars={{ API_BASE_URL, id }}>
        document.addEventListener('DOMContentLoaded', () => {
            function showToast(message, type = "success") {
                const container = document.getElementById("toast-container");
                if (!container) return;

                const toast = document.createElement("div");
                const bgColor = type === "success" ? "bg-green-600" : "bg-red-600";
                toast.className = `${bgColor} text-white px-6 py-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-bold flex items-center gap-3 min-w-[300px] toast-enter`;

                toast.innerHTML = `
                    <span class="flex-1">${message}</span>
                    <button class="hover:text-gray-200" onclick="this.parentElement.remove()">‚úï</button>
                `;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove("toast-enter");
                    toast.classList.add("toast-exit");
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            const reviewForm = document.getElementById("reviewForm");
            const ratingText = document.getElementById('rating-text');
            const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            const starLabels = document.querySelectorAll('label[for^="rating-"]');

            function updateStarDisplay(selectedRating) {
                starLabels.forEach((label, index) => {
                    const starIcon = label.querySelector('svg');
                    if (starIcon) {
                        if (index < selectedRating) {
                            starIcon.classList.remove('text-gray-300');
                            starIcon.classList.add('text-black');
                        } else {
                            starIcon.classList.remove('text-black');
                            starIcon.classList.add('text-gray-300');
                        }
                    }
                });
            }

            updateStarDisplay(0);

            starLabels.forEach((label, index) => {
                const input = document.getElementById(`rating-${index + 1}`);
                
                label.addEventListener('click', (e) => {
                    e.preventDefault();
                    const rating = index + 1;
                    input.checked = true;
                    updateStarDisplay(rating);
                    if (ratingText) {
                        ratingText.textContent = `${rating}.0 - ${ratingTexts[rating - 1]}`;
                        ratingText.classList.remove('text-gray-400');
                        ratingText.classList.add('text-black');
                    }
                });

                label.addEventListener('mouseenter', () => {
                    updateStarDisplay(index + 1);
                });

                label.addEventListener('mouseleave', () => {
                    const selectedInput = document.querySelector('input[name="rating"]:checked');
                    updateStarDisplay(selectedInput ? parseInt(selectedInput.value) : 0);
                });
            });


            async function checkAuth() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/auth/check`, {
                        credentials: 'include'
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Auth check failed:', error);
                    return false;
                }
            }

            reviewForm?.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const submitButton = reviewForm.querySelector('button[type="submit"]');
                if (!submitButton) return;
                
                const originalButtonText = submitButton.innerHTML;
                
                try {
                    submitButton.disabled = true;
                    submitButton.innerHTML = `SUBMITTING...`;

                    const formData = new FormData(reviewForm);
                    const rating = formData.get('rating');
                    const feedback = formData.get('feedback');

                    const eventId = document.querySelector('[data-event-id]')?.dataset.eventId;
                    
                    if (!rating) {
                        throw new Error('Please select a rating');
                    }

                    const response = await fetch(`${API_BASE_URL}/api/reviews`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            eventId: eventId,
                            rating: parseInt(rating),
                            feedback: feedback?.toString().trim() || ''
                        }),
                    });
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.message || 'Failed to submit review');
                    }
                    
                    showToast('Thank you for your review!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                    
                } catch (error) {
                    console.error("Error submitting review:", error);
                    showToast(error.message || 'An error occurred. Please try again.', 'error');
                    
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });

            async function loadUserReview() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reviews/event/${id}/user-review`, {
                         credentials: 'include'
                    });
                } catch (error) {
                    console.error('Error loading user review:', error);
                }
            }

            const joinBtn = document.getElementById('joinEventBtn');
            
            if (joinBtn) {
                const eventId = joinBtn.dataset.eventId;
                
                // Check registration status on page load
                async function checkRegistrationStatus() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/registration/status/${eventId}`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.isRegistered) {
                                // User is already registered
                                joinBtn.textContent = '‚úì ALREADY REGISTERED';
                                joinBtn.classList.remove('bg-black', 'hover:bg-gray-800');
                                joinBtn.classList.add('bg-green-600', 'border-green-800', 'text-white');
                                joinBtn.disabled = true;
                            }
                        }
                    } catch (error) {
                        console.error('Error checking registration:', error);
                    }
                }
                
                if (eventId) {
                    checkRegistrationStatus();
                }
                
                joinBtn.addEventListener('click', async function() {
                    const eventId = this.dataset.eventId;
                    
                    if (!eventId) {
                        showToast('Invalid event', 'error');
                        return;
                    }

                    // Disable button during request
                    joinBtn.disabled = true;
                    const originalText = joinBtn.textContent;
                    joinBtn.textContent = 'REGISTERING...';

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/registration/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include', // Important: sends cookies
                            body: JSON.stringify({ eventId })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            joinBtn.textContent = '‚úì REGISTRATION SUCCESSFUL!';
                            joinBtn.classList.remove('bg-black', 'hover:bg-gray-800');
                            joinBtn.classList.add('bg-green-600', 'border-green-800', 'text-white');
                            // Keep disabled
                            
                            showToast('Successfully registered for the event!', 'success');
                        } else {
                            // Handle errors
                            if (response.status === 401) {
                                showToast('Please login to register for this event', 'error');
                                setTimeout(() => window.location.href = '/login', 1500);
                            } else {
                                showToast(result.message || 'Registration failed', 'error');
                                joinBtn.disabled = false;
                                joinBtn.textContent = originalText;
                            }
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        showToast('An error occurred. Please try again.', 'error');
                        joinBtn.disabled = false;
                        joinBtn.textContent = originalText;
                    }
                });
            }
        });
    </script>
</Layout>
