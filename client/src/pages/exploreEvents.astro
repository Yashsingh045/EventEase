---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import { API_BASE_URL } from "../config";

const token = Astro.cookies.get("token")?.value;

if (!token) {
    return Astro.redirect("/login");
}

let events: any[] = [];
try {
    const response = await fetch(`${API_BASE_URL}/api/event`, {
        headers: {
            Authorization: `Bearer ${token}`,
        },
    });
    if (response.ok) {
        const data = await response.json();
        events = data.events || [];
    } else {
        console.error("Failed to fetch events:", response.status);
    }
} catch (error) {
    console.error("Failed to fetch events:", error);
}
---

<Layout title="Tech Events">
    <Navbar />
    <div class="text-center m-12">
        <h2
            class="text-4xl font-bold text-gray-800 mb-4 bg-gradient-to-br from-blue-600 to-teal-600 bg-clip-text text-transparent"
        >
            Explore Events
        </h2>
        <p class="text-lg text-gray-500 max-w-2xl mx-auto">
            Trusted by thousands of event organizers worldwide
        </p>
    </div>

    <div
        class="max-w-7xl mx-auto p-6 flex flex-col lg:flex-row gap-6 text-gray-800 bg-gradient-to-b from-gray-50 to-white"
    >
        <!-- Sidebar (filters + sorting) -->
        <aside
            class="sidebar w-full lg:w-[300px] bg-white border-2 border-black p-5 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] h-fit lg:sticky lg:top-6 rounded-none"
        >
            <h2 class="mb-6 text-lg font-bold text-gray-800">Filters</h2>

            <div class="mb-4">
                <label class="block mb-2 text-gray-500 text-sm">Search</label>
                <input
                    id="searchInput"
                    class="w-full p-2.5 bg-white border-2 border-black text-gray-800 rounded-none outline-none focus:border-blue-500 transition-all"
                    placeholder="Search title or venue"
                />
            </div>

            <div class="mb-4">
                <label class="block mb-2 text-gray-500 text-sm">Category</label>
                <div class="checkbox-grid">
                    <label
                        class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                        ><input
                            type="checkbox"
                            class="filter-category w-4 h-4 mr-2 accent-blue-500 rounded"
                            value="Machine Learning/AI"
                        /> Machine Learning/AI</label
                    >
                    <label
                        class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                        ><input
                            type="checkbox"
                            class="filter-category w-4 h-4 mr-2 accent-blue-500 rounded"
                            value="Creative AI"
                        /> Creative AI</label
                    >
                    <label
                        class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                        ><input
                            type="checkbox"
                            class="filter-category w-4 h-4 mr-2 accent-blue-500 rounded"
                            value="Gaming"
                        /> Gaming</label
                    >
                    <label
                        class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                        ><input
                            type="checkbox"
                            class="filter-category w-4 h-4 mr-2 accent-blue-500 rounded"
                            value="Cybersecurity"
                        /> Cybersecurity</label
                    >
                </div>
            </div>

            <div class="mb-4">
                <label class="block mb-2 text-gray-500 text-sm">Price</label>
                <label
                    class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                    ><input
                        type="checkbox"
                        class="filter-price w-4 h-4 mr-2 accent-blue-500 rounded"
                        value="free"
                    /> Free</label
                >
                <label
                    class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                    ><input
                        type="checkbox"
                        class="filter-price w-4 h-4 mr-2 accent-blue-500 rounded"
                        value="paid"
                    /> Paid</label
                >
            </div>

            <div class="mb-4">
                <label class="block mb-2 text-gray-500 text-sm">Date</label>
                <label
                    class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                    ><input
                        type="checkbox"
                        class="filter-date w-4 h-4 mr-2 accent-blue-500 rounded"
                        value="upcoming"
                    /> Upcoming</label
                >
                <label
                    class="block py-1.5 text-gray-500 text-sm cursor-pointer flex items-center"
                    ><input
                        type="checkbox"
                        class="filter-date w-4 h-4 mr-2 accent-blue-500 rounded"
                        value="past"
                    /> Past</label
                >
            </div>

            <div class="mb-4">
                <label class="block mb-2 text-gray-500 text-sm">Sort</label>
                <select
                    id="sortSelect"
                    class="w-full p-2.5 bg-white border-2 border-black text-gray-800 rounded-none outline-none focus:border-blue-500 transition-all"
                >
                    <option value="latest">Latest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="price-asc">Price: Low to High</option>
                    <option value="price-desc">Price: High to Low</option>
                </select>
            </div>

            <div class="mb-4">
                <button
                    id="resetBtn"
                    class="w-full py-2 px-3 bg-white text-black border-2 border-black rounded-none cursor-pointer font-bold hover:bg-gray-100 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-0.5 transition-all"
                    >Reset filters</button
                >
            </div>
        </aside>

        <!-- Events list -->
        <main class="events flex-1 flex flex-col gap-5 min-w-0" id="eventsList">
            <!-- Cards rendered server-side; JS will filter/sort them on the client -->
            {
                events.map((event) => {
                    // data-* attributes used by the client filtering code
                    const startISO = event.startTime;
                    const endISO = event.endTime;
                    const price = Number(event.price ?? 0);
                    return (
                        <article
                            class="card grid grid-cols-1 md:grid-cols-[140px_1fr_180px] gap-5 items-start bg-white border-2 border-black p-4 rounded-none transition-all hover:-translate-y-1 hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                            data-id={event.publicId}
                            data-title={event.title}
                            data-category={event.category}
                            data-venue={event.venue}
                            data-start={startISO}
                            data-end={endISO}
                            data-price={price}
                        >
                            <div class="h-full">
                                <img
                                    src={event.posterUrl}
                                    alt={event.title}
                                    class="w-full h-full object-cover rounded-none bg-gray-100 border-2 border-black"
                                />
                            </div>

                            <div class="min-h-[1px]">
                                <header class="mb-1.5">
                                    <h3 class="text-xl font-bold text-gray-800 leading-tight mb-1.5">
                                        {event.title}
                                    </h3>
                                    <div class="flex gap-2 items-center text-gray-500 text-sm mb-4">
                                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-none border border-black font-bold text-xs">
                                            {event.category}
                                        </span>
                                        <span class="text-gray-400">@</span>
                                        <span class="text-gray-500">
                                            {event.venue}
                                        </span>
                                    </div>
                                </header>

                                <p class="mb-3 text-gray-500 text-sm line-clamp-2">
                                    {event.description}
                                </p>

                                <div class="flex justify-between gap-3 items-center mt-2 flex-wrap">
                                    <div class="flex gap-2 items-center text-gray-500 text-sm">
                                        <div class="flex gap-2 items-center text-gray-500 text-sm">
                                            <svg
                                                class="w-4 h-4 opacity-90 text-gray-400"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    fill="currentColor"
                                                    d="M7 10h5v5H7z"
                                                />
                                            </svg>
                                            <span class="text-gray-500">
                                                {new Date(
                                                    event.startTime,
                                                ).toLocaleDateString()}
                                            </span>
                                            <span class="dash">-</span>
                                            <span class="text-gray-500">
                                                {new Date(
                                                    event.endTime,
                                                ).toLocaleDateString()}
                                            </span>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-3">
                                        <div class="text-black bg-yellow-100 px-2.5 py-1.5 rounded-none border-2 border-black font-bold text-sm">
                                            {event.price === 0
                                                ? "Free"
                                                : `$${event.price.toFixed(2)}`}
                                        </div>
                                        <a
                                            class="bg-black text-white px-3 py-2 rounded-none font-bold shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-0.5 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all text-sm no-underline border-2 border-black"
                                            href={`/events/${event.publicId}`}
                                        >
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col items-end gap-2 text-gray-500 md:border-l md:border-dashed md:border-gray-200 md:pl-4 md:h-full md:justify-center">
                                <div class="bg-purple-100 px-2.5 py-1.5 rounded-none border border-black text-purple-700 font-bold text-sm">
                                    {event.organizer?.name ?? "Organizer"}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {event.capacity?.toLocaleString() ?? "—"}{" "}
                                    seats
                                </div>
                                <button
                                    class="register-btn px-3 py-2 rounded-none border-2 border-black text-black bg-white font-bold hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-0.5 transition-all text-sm cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"
                                    data-event-id={event.publicId}
                                    title="Click to register for this event"
                                >
                                    Register
                                </button>
                            </div>
                        </article>
                    );
                })
            }
        </main>
    </div>

    <!-- Client-side filtering & sorting -->
    <script>
        import api from "../lib/api";
        import { checkAuth } from "../lib/auth";

        (async () => {
            const user = await checkAuth();
            if (!user) {
                window.location.href = "/login";
                return;
            }

            // helper
            const q = (sel, root = document) => root.querySelector(sel);
            const qa = (sel, root = document) =>
                Array.from(root.querySelectorAll(sel));

            const eventsList = q("#eventsList");
            const cards = qa(".card", eventsList);

            const searchInput = q("#searchInput");
            const categoryChecks = qa(".filter-category");
            const priceChecks = qa(".filter-price");
            const dateChecks = qa(".filter-date");
            const sortSelect = q("#sortSelect");
            const resetBtn = q("#resetBtn");

            // parse checkboxes to arrays
            const selected = {
                categories: [],
                prices: [],
                dates: [],
                search: "",
            };

            function updateSelected() {
                selected.categories = categoryChecks
                    .filter((c) => c.checked)
                    .map((c) => c.value);
                selected.prices = priceChecks
                    .filter((c) => c.checked)
                    .map((c) => c.value);
                selected.dates = dateChecks
                    .filter((c) => c.checked)
                    .map((c) => c.value);
                selected.search = searchInput.value.trim().toLowerCase();
            }

            function isUpcoming(startISO) {
                return new Date(startISO) >= new Date();
            }

            function matchesCard(card) {
                // title/venue search
                if (selected.search) {
                    const title = (card.dataset.title || "").toLowerCase();
                    const venue = (card.dataset.venue || "").toLowerCase();
                    if (
                        !title.includes(selected.search) &&
                        !venue.includes(selected.search)
                    )
                        return false;
                }

                // category
                if (selected.categories.length > 0) {
                    if (
                        !selected.categories.includes(
                            card.dataset.category || "",
                        )
                    )
                        return false;
                }

                // price (free / paid)
                if (selected.prices.length > 0) {
                    const isFree = Number(card.dataset.price) === 0;
                    if (selected.prices.includes("free") && !isFree)
                        return false;
                    if (selected.prices.includes("paid") && isFree)
                        return false;
                }

                // date (upcoming / past)
                if (selected.dates.length > 0) {
                    const start = card.dataset.start || "";
                    const upcoming = isUpcoming(start);
                    if (selected.dates.includes("upcoming") && !upcoming)
                        return false;
                    if (selected.dates.includes("past") && upcoming)
                        return false;
                }

                return true;
            }

            function applyFiltersAndSort() {
                updateSelected();

                // Filter
                let visible = cards.filter((c) => {
                    const ok = matchesCard(c);
                    c.style.display = ok ? "grid" : "none";
                    return ok;
                });

                // Sort
                const sortMode = sortSelect.value;
                visible.sort((a, b) => {
                    if (sortMode === "latest") {
                        // soonest start first
                        return (
                            new Date(a.dataset.start || "").getTime() -
                            new Date(b.dataset.start || "").getTime()
                        );
                    } else if (sortMode === "oldest") {
                        return (
                            new Date(b.dataset.start || "").getTime() -
                            new Date(a.dataset.start || "").getTime()
                        );
                    } else if (sortMode === "price-asc") {
                        return (
                            Number(a.dataset.price) - Number(b.dataset.price)
                        );
                    } else if (sortMode === "price-desc") {
                        return (
                            Number(b.dataset.price) - Number(a.dataset.price)
                        );
                    }
                    return 0;
                });

                // Re-append in new order (keeps DOM nodes)
                visible.forEach((node) => eventsList?.appendChild(node));
            }

            // Event listeners
            searchInput?.addEventListener("input", () => applyFiltersAndSort());
            categoryChecks.forEach((cb) =>
                cb.addEventListener("change", () => applyFiltersAndSort()),
            );
            priceChecks.forEach((cb) =>
                cb.addEventListener("change", () => applyFiltersAndSort()),
            );
            dateChecks.forEach((cb) =>
                cb.addEventListener("change", () => applyFiltersAndSort()),
            );
            sortSelect?.addEventListener("change", () => applyFiltersAndSort());

            resetBtn?.addEventListener("click", () => {
                // reset inputs
                searchInput.value = "";
                categoryChecks.forEach((cb) => (cb.checked = false));
                priceChecks.forEach((cb) => (cb.checked = false));
                dateChecks.forEach((cb) => (cb.checked = false));
                sortSelect.value = "latest";
                applyFiltersAndSort();
            });

            // initial sort
            applyFiltersAndSort();

            // Check registration status for all events on page load
            async function checkAllRegistrations() {
                const registerButtons =
                    document.querySelectorAll(".register-btn");

                for (const btn of registerButtons) {
                    const button = btn;
                    const eventId = button.dataset.eventId || "";

                    if (!eventId) continue;

                    try {
                        const response = await api.get(
                            `/api/registration/status/${eventId}`,
                        );

                        if (response.status === 200) {
                            const result = response.data;
                            if (result.isRegistered) {
                                // User is already registered
                                button.textContent = "✓ Registered";
                                button.classList.remove(
                                    "border-black",
                                    "text-black",
                                    "bg-white",
                                );
                                button.classList.add(
                                    "border-green-500",
                                    "text-green-700",
                                    "bg-green-100",
                                );
                                button.disabled = true;
                                button.title =
                                    "Already registered for this event";
                            }
                        }
                    } catch (error) {
                        // User not logged in or error - leave button as is
                        console.error("Error checking registration:", error);
                    }
                }
            }

            // Check registrations on load
            checkAllRegistrations();

            // Event Registration
            const registerButtons = document.querySelectorAll(".register-btn");
            registerButtons.forEach((btn) => {
                btn.addEventListener("click", async function (e) {
                    e.preventDefault();
                    const button = this;
                    const eventId = button.dataset.eventId || "";

                    if (!eventId) {
                        alert("Invalid event");
                        return;
                    }

                    // Disable button during request
                    button.disabled = true;
                    const originalText = button.textContent;
                    button.textContent = "Registering...";

                    try {
                        const response = await api.post(
                            "/api/registration/register",
                            { eventId },
                        );

                        const result = response.data;

                        if (
                            response.status === 200 ||
                            response.status === 201
                        ) {
                            button.textContent = "✓ Registered";
                            button.classList.remove(
                                "border-black",
                                "text-black",
                                "bg-white",
                            );
                            button.classList.add(
                                "border-green-500",
                                "text-green-700",
                                "bg-green-100",
                            );
                            button.title = "Already registered for this event";
                            // Keep disabled
                        } else {
                            alert(result.message || "Registration failed");
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    } catch (error) {
                        console.error("Registration error:", error);
                        if (error.response && error.response.status === 401) {
                            alert("Please login to register for events");
                            window.location.href = "/login";
                        } else {
                            const message =
                                error.response?.data?.message ||
                                "An error occurred. Please try again.";
                            alert(message);
                        }
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                });
            });
        })();
    </script>

    <Footer />
</Layout>
