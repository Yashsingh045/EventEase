---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import UserSidebar from "../components/dashboard/UserSidebar.astro";
import EventModal from "../components/dashboard/EventModal.astro";
import TicketModal from "../components/dashboard/TicketModal.astro";
import ProfileSettings from "../components/dashboard/ProfileSettings.astro";
import ToastContainer from "../components/dashboard/ToastContainer.astro";
import EventCalendar from "../components/EventCalendar.astro";

const url = new URL(Astro.request.url);
const tokenFromUrl = url.searchParams.get("token");

// Server-side redirect check
const cookie = Astro.request.headers.get("cookie") || "";
const hasToken = cookie.includes("token=") || tokenFromUrl;

if (!hasToken) {
    return Astro.redirect("/login");
}
---

<Layout title="User Dashboard - EventEase">
    <div class="flex h-screen bg-gray-50 overflow-hidden">
        <UserSidebar />

        <div class="flex-1 flex flex-col overflow-hidden">
            <Navbar dashboard={true} />

            <main class="flex-1 overflow-y-auto p-8 bg-gray-50">
                <div class="mb-6 lg:hidden">
                    <button
                        id="toggleSidebar"
                        class="text-gray-600 hover:text-gray-900 text-2xl"
                    >
                        ≡
                    </button>
                </div>
                <div id="discover-page" class="page-content">
                    <div class="flex justify-between items-center mb-8">
                        <h1
                            class="text-4xl font-black text-gray-900 tracking-tight uppercase"
                            style="font-family: 'Poppins', sans-serif;"
                        >
                            Discover Events
                        </h1>
                        <div class="flex gap-2">
                            <button
                                id="gridViewBtn"
                                class="btn btn-sm btn-ghost text-lg hover:bg-gray-100 active-layout"
                                onclick="toggleLayout('grid')"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    ><path
                                        stroke-linecap="square"
                                        stroke-linejoin="miter"
                                        stroke-width="2"
                                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                                    ></path></svg
                                >
                            </button>
                            <button
                                id="listViewBtn"
                                class="btn btn-sm btn-ghost text-lg hover:bg-gray-100"
                                onclick="toggleLayout('list')"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    ><path
                                        stroke-linecap="square"
                                        stroke-linejoin="miter"
                                        stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16"></path></svg
                                >
                            </button>
                        </div>
                    </div>

                    <div
                        class="bg-white p-8 border-2 border-black mb-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                    >
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                            <input
                                type="text"
                                id="searchEvents"
                                placeholder="Search events..."
                                class="input input-bordered border-2 border-black focus:outline-none focus:ring-0 focus:border-blue-600 col-span-1 md:col-span-4 font-bold placeholder-gray-500"
                            />

                            <select
                                id="filterCategory"
                                class="select select-bordered border-2 border-black focus:outline-none focus:ring-0 focus:border-blue-600 font-bold"
                            >
                                <option disabled selected>Category</option>
                                <option>Technology</option>
                                <option>Cultural</option>
                                <option>Sports</option>
                                <option>Academic</option>
                            </select>

                            <input
                                type="date"
                                id="filterDate"
                                class="input input-bordered border-2 border-black focus:outline-none focus:ring-0 focus:border-blue-600 font-bold"
                            />

                            <select
                                id="filterVenue"
                                class="select select-bordered border-2 border-black focus:outline-none focus:ring-0 focus:border-blue-600 font-bold"
                            >
                                <option disabled selected>Location</option>
                                <option>Main Auditorium</option>
                                <option>Sports Complex</option>
                                <option>Online</option>
                            </select>

                            <button
                                class="btn btn-primary border-2 border-black bg-blue-600 hover:bg-blue-700 text-white font-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[1px] hover:shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] transition-all"
                                id="filterBtn"
                            >
                                FILTER
                            </button>
                        </div>
                    </div>

                    <div
                        id="eventsGrid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                    >
                        <!-- Events will be loaded here dynamically -->
                        <div
                            class="col-span-full text-center py-10 text-gray-500"
                        >
                            Loading events...
                        </div>
                    </div>
                </div>

                <div id="myevents-page" class="page-content hidden">
                    <h1
                        class="text-4xl font-black text-gray-900 mb-8 tracking-tight"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        My Events
                    </h1>
                    <div
                        id="myEventsList"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6"
                    >
                        <div
                            class="col-span-full text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                        >
                            <p
                                class="text-gray-900 text-lg font-bold uppercase tracking-wider"
                                style="font-family: 'Poppins', sans-serif;"
                            >
                                Loading your events...
                            </p>
                        </div>
                    </div>
                </div>
                <div id="calendar-page" class="page-content hidden">
                    <h1
                        class="text-4xl font-black text-gray-900 mb-8 tracking-tight"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        Event Calendar
                    </h1>
                    <EventCalendar />
                </div>
                <div id="past-page" class="page-content hidden">
                    <h1
                        class="text-4xl font-black text-gray-900 mb-8 tracking-tight"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        Past Events
                    </h1>
                    <div
                        id="pastEventsList"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6"
                    >
                        <div
                            class="col-span-full text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                        >
                            <p
                                class="text-gray-500 text-lg font-bold uppercase tracking-wide"
                                style="font-family: 'Poppins', sans-serif;"
                            >
                                Loading past events...
                            </p>
                        </div>
                    </div>
                </div>

                <div id="certificates-page" class="page-content hidden">
                    <h1
                        class="text-4xl font-black text-gray-900 mb-8 tracking-tight"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        Certificates & Achievements
                    </h1>
                    <div
                        class="text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                    >
                        <p
                            class="text-gray-500 text-lg font-bold uppercase tracking-wide"
                            style="font-family: 'Poppins', sans-serif;"
                        >
                            No certificates available yet
                        </p>
                    </div>
                </div>

                <div id="notifications-page" class="page-content hidden">
                    <h1
                        class="text-4xl font-black text-gray-900 mb-8 tracking-tight uppercase"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        Notifications
                    </h1>
                    <div class="space-y-4" id="notificationsList">
                        <div
                            class="bg-white p-8 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] text-center"
                        >
                            <p class="text-gray-500 font-bold text-lg">
                                No new notifications
                            </p>
                        </div>
                    </div>
                </div>

                <div id="profile-page" class="page-content hidden">
                    <h1
                        class="text-4xl font-black text-gray-900 mb-8 tracking-tight"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        Profile Settings
                    </h1>
                    <ProfileSettings />
                </div>
            </main>

            <div
                id="sidebarOverlay"
                class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"
            >
            </div>

            <EventModal />
            <TicketModal />
            <ToastContainer />
        </div>

        <script>
            import api from "../lib/api";
            import { checkAuth } from "../lib/auth";

            declare global {
                interface Window {
                    openTicketModal: (
                        ticketId: string,
                        eventTitle: string,
                        eventDate: string,
                        eventVenue: string,
                        qrCodeUrl: string,
                        attendeeName: string,
                    ) => void;
                }
            }

            function handleOAuthToken() {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get("token");

                if (token) {
                    document.cookie = `token=${token}; path=/; max-age=${24 * 60 * 60}; SameSite=Lax`;

                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
            }

            handleOAuthToken();

            document.addEventListener("DOMContentLoaded", async () => {
                const user = await checkAuth();
                if (!user) {
                    window.location.href = "/login";
                    return;
                }

                let registeredEventIds = new Set();

                const sidebar = document.getElementById("sidebar");
                const sidebarOverlay =
                    document.getElementById("sidebarOverlay");
                const toggleSidebar = document.getElementById("toggleSidebar");
                const closeSidebar = document.getElementById("closeSidebar");
                const navLinks = document.querySelectorAll(
                    ".nav-link[data-page]",
                );
                const pages = document.querySelectorAll(".page-content");
                const currentPageBreadcrumb =
                    document.getElementById("currentPage");

                toggleSidebar?.addEventListener("click", () => {
                    sidebar?.classList.remove("-translate-x-full");
                    sidebarOverlay?.classList.remove("hidden");
                });

                closeSidebar?.addEventListener("click", () => {
                    sidebar?.classList.add("-translate-x-full");
                    sidebarOverlay?.classList.add("hidden");
                });

                sidebarOverlay?.addEventListener("click", () => {
                    sidebar?.classList.add("-translate-x-full");
                    sidebarOverlay?.classList.add("hidden");
                });

                navLinks.forEach((link) => {
                    link.addEventListener("click", (e) => {
                        e.preventDefault();

                        navLinks.forEach((l) => l.classList.remove("active"));
                        link.classList.add("active");

                        const pageId = (link as HTMLElement).dataset.page;
                        pages.forEach((page) => page.classList.add("hidden"));

                        const targetPage = document.getElementById(
                            `${pageId}-page`,
                        );
                        if (targetPage) {
                            targetPage.classList.remove("hidden");
                            const pageTitle = link.textContent.trim();
                            if (currentPageBreadcrumb) {
                                currentPageBreadcrumb.textContent = pageTitle;
                            }

                            if (pageId === "discover") fetchEvents();
                            if (pageId === "myevents") fetchMyEvents();
                            if (pageId === "past") fetchPastEvents();
                        }

                        if (window.innerWidth < 1024) {
                            sidebar?.classList.add("-translate-x-full");
                            sidebarOverlay?.classList.add("hidden");
                        }
                    });
                });

                async function fetchUserProfile() {
                    try {
                        const res = await api.get("/api/user/me");
                        if (res.status === 200) {
                            const { data } = res.data;
                            const firstNameInput = document.getElementById(
                                "profileFirstName",
                            ) as HTMLInputElement;
                            const lastNameInput = document.getElementById(
                                "profileLastName",
                            ) as HTMLInputElement;
                            const emailInput = document.getElementById(
                                "profileEmail",
                            ) as HTMLInputElement;
                            const phoneInput = document.getElementById(
                                "profilePhone",
                            ) as HTMLInputElement;

                            if (firstNameInput)
                                firstNameInput.value = data.firstName || "";
                            if (lastNameInput)
                                lastNameInput.value = data.lastName || "";
                            if (emailInput) emailInput.value = data.email || "";
                            if (phoneInput) phoneInput.value = data.phone || "";

                            const userNameElements = document.querySelectorAll(
                                ".user-name, h3.font-bold.text-lg.text-gray-900",
                            );
                            userNameElements.forEach(
                                (el) =>
                                    (el.textContent = `${data.firstName} ${data.lastName}`),
                            );

                            const initials =
                                `${data.firstName[0]}${data.lastName[0]}`.toUpperCase();
                            document
                                .querySelectorAll(".avatar span")
                                .forEach((el) => (el.textContent = initials));

                            const sidebarEmail =
                                document.getElementById("sidebar-user-email");
                            if (sidebarEmail)
                                sidebarEmail.textContent = data.email;

                            const sidebarInitials = document.getElementById(
                                "sidebar-user-initials",
                            );
                            if (sidebarInitials)
                                sidebarInitials.textContent = initials;

                            const organizerLink =
                                document.getElementById("organizerLink");
                            if (organizerLink) {
                                if (
                                    data.role === "ORGANIZER" ||
                                    data.role === "BOTH"
                                ) {
                                    organizerLink.classList.remove("hidden");
                                } else {
                                    organizerLink.classList.add("hidden");
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Failed to fetch profile", e);
                    }
                }

                const profileForm = document.getElementById("profileForm");
                profileForm?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target as HTMLFormElement);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const res = await api.put("/api/user/update", data);
                        if (res.status === 200) {
                            showToast(
                                "Profile updated successfully!",
                                "success",
                            );
                            fetchUserProfile();
                        } else {
                            showToast("Failed to update profile", "error");
                        }
                    } catch (e) {
                        console.error(e);
                        showToast("Error updating profile", "error");
                    }
                });

                async function fetchRegisteredEventIds() {
                    try {
                        const res = await api.get(
                            "/api/registration/my-registrations",
                        );
                        const { data } = res.data;
                        registeredEventIds = new Set(
                            data.map((reg: any) => reg.event.publicId),
                        );
                    } catch (e) {
                        console.error("Failed to fetch registrations", e);
                    }
                }

                async function fetchEvents(params = {}) {
                    const grid = document.getElementById("eventsGrid");
                    if (!grid) return;
                    grid.innerHTML =
                        '<div class="col-span-full text-center py-10 text-gray-500">Loading events...</div>';

                    try {
                        const query = new URLSearchParams(params).toString();
                        const res = await api.get(`/api/event/?${query}`);
                        const { events } = res.data;

                        if (events.length === 0) {
                            grid.innerHTML =
                                '<div class="col-span-full text-center py-10 text-gray-500">No upcoming events found.</div>';
                            return;
                        }

                        grid.innerHTML = events
                            .map((event) => {
                                const isRegistered = registeredEventIds.has(
                                    event.publicId,
                                );
                                const btnText = isRegistered
                                    ? "Registered"
                                    : "View Details";
                                const btnClass = isRegistered
                                    ? "btn-success bg-green-600 border-green-800 text-white"
                                    : "btn-primary bg-black text-white hover:bg-gray-800";

                                if (currentLayout === "list") {
                                    return `
                                    <div class="card bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all hover:-translate-y-1 overflow-hidden rounded-none flex-row h-64">
                                        <figure class="w-48 h-full bg-gray-200 relative border-r-2 border-black shrink-0">
                                            <img src="${event.posterUrl || "https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1770&q=80"}" class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-500" />
                                        </figure>
                                        <div class="card-body p-6 flex-1">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h2 class="card-title text-xl font-black text-gray-900 mb-2 line-clamp-1 uppercase tracking-tight">${event.title}</h2>
                                                    <span class="badge bg-white text-black border-2 border-black font-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] uppercase tracking-wider rounded-none mb-2">${event.category}</span>
                                                </div>
                                                <span class="font-black text-xl text-blue-600">${event.price > 0 ? "$" + event.price : "Free"}</span>
                                            </div>
                                            <div class="space-y-2 text-sm text-gray-700 mb-4 font-medium">
                                                <div class="flex items-center gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                    ${new Date(event.date).toLocaleDateString()}
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                    ${event.venue}
                                                </div>
                                            </div>
                                            <div class="card-actions justify-end mt-auto">
                                                <button class="btn btn-sm font-bold border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)] rounded-none uppercase tracking-wide ${btnClass}" onclick="openEventModal('${event.publicId}')">${btnText}</button>
                                            </div>
                                        </div>
                                    </div>`;
                                }

                                return `
                <div class="card bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all hover:-translate-y-1 overflow-hidden rounded-none">
                  <figure class="h-48 bg-gray-200 relative border-b-2 border-black">
                    <img src="${event.posterUrl || "https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1770&q=80"}" class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-500" />
                    <div class="absolute top-4 right-4">
                        <span class="badge bg-white text-black border-2 border-black font-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] uppercase tracking-wider rounded-none">${event.category}</span>
                    </div>
                  </figure>
                  <div class="card-body p-6">
                    <h2 class="card-title text-xl font-black text-gray-900 mb-2 line-clamp-1 uppercase tracking-tight">${event.title}</h2>
                    <div class="space-y-2 text-sm text-gray-700 mb-6 font-medium">
                      <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        ${new Date(event.date).toLocaleDateString()}
                      </div>
                      <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        ${event.venue}
                      </div>
                    </div>
                    <div class="card-actions justify-between items-center mt-auto pt-4 border-t-2 border-gray-100">
                      <span class="font-black text-xl text-blue-600">${event.price > 0 ? "$" + event.price : "Free"}</span>
                      <button class="btn btn-sm font-bold border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)] rounded-none uppercase tracking-wide ${btnClass}" onclick="openEventModal('${event.publicId}')">${btnText}</button>
                    </div>
                  </div>
                </div>
            `;
                            })
                            .join("");
                    } catch (e) {
                        console.error(e);
                        grid.innerHTML =
                            '<div class="col-span-full text-center py-10 text-red-500">Failed to load events.</div>';
                    }
                }

                (window as any).openEventModal = async (id) => {
                    try {
                        const res = await api.get(`/api/event/${id}`);
                        const { event: data } = res.data;

                        const modal = document.getElementById(
                            "eventModal",
                        ) as HTMLDialogElement;
                        document.getElementById("modalTitle")!.textContent =
                            data.title;
                        document.getElementById("modalCategory")!.textContent =
                            data.category;
                        document.getElementById(
                            "modalDescription",
                        )!.textContent = data.description;
                        document.getElementById(
                            "modalLongDescription",
                        )!.textContent = data.longDescription || "";
                        document.getElementById("modalDate")!.textContent =
                            new Date(data.date).toLocaleDateString();
                        document.getElementById("modalTime")!.textContent =
                            new Date(data.startTime).toLocaleTimeString([], {
                                hour: "2-digit",
                                minute: "2-digit",
                            });
                        document.getElementById("modalVenue")!.textContent =
                            data.venue;
                        document.getElementById("modalPrice")!.textContent =
                            data.price > 0 ? `$${data.price}` : "Free";
                        document.getElementById("modalOrganizer")!.textContent =
                            `${data.organizer.firstName} ${data.organizer.lastName}`;
                        (
                            document.getElementById(
                                "modalImage",
                            ) as HTMLImageElement
                        ).src =
                            data.posterUrl ||
                            "https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1770&q=80";

                        const registerBtn =
                            document.getElementById("registerBtn");
                        const fullPageBtn = document.getElementById(
                            "fullPageBtn",
                        ) as HTMLAnchorElement;
                        if (fullPageBtn) fullPageBtn.href = `/events/${id}`;

                        const isRegistered = registeredEventIds.has(id);

                        if (isRegistered) {
                            registerBtn!.textContent = "Registered";
                            registerBtn!.classList.remove(
                                "bg-black",
                                "hover:bg-gray-800",
                            );
                            registerBtn!.classList.add(
                                "bg-green-600",
                                "hover:bg-green-700",
                                "cursor-not-allowed",
                            );
                            (registerBtn as HTMLButtonElement).disabled = true;
                            registerBtn!.onclick = null;
                        } else {
                            registerBtn!.textContent = "Register Now";
                            registerBtn!.classList.remove(
                                "bg-green-600",
                                "hover:bg-green-700",
                                "cursor-not-allowed",
                            );
                            registerBtn!.classList.add(
                                "bg-black",
                                "hover:bg-gray-800",
                            );
                            (registerBtn as HTMLButtonElement).disabled = false;
                            registerBtn!.onclick = () => registerForEvent(id);
                        }

                        modal.showModal();
                    } catch (e) {
                        console.error(e);
                    }
                };

                function showToast(message, type = "success") {
                    const container =
                        document.getElementById("toast-container");
                    if (!container) return;

                    const toast = document.createElement("div");
                    const bgColor =
                        type === "success" ? "bg-green-600" : "bg-red-600";
                    toast.className = `${bgColor} text-white px-6 py-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-bold flex items-center gap-3 min-w-[300px] toast-enter`;

                    toast.innerHTML = `
                        <span class="flex-1">${message}</span>
                        <button class="hover:text-gray-200" onclick="this.parentElement.remove()">✕</button>
                    `;

                    container.appendChild(toast);

                    setTimeout(() => {
                        toast.classList.remove("toast-enter");
                        toast.classList.add("toast-exit");
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                }

                async function registerForEvent(id) {
                    try {
                        const res = await api.post(
                            "/api/registration/register",
                            {
                                eventId: id,
                            },
                        );
                        const result = res.data;
                        if (res.status === 200 || res.status === 201) {
                            showToast("Successfully registered!", "success");
                            (
                                document.getElementById(
                                    "eventModal",
                                ) as HTMLDialogElement
                            ).close();
                            await fetchRegisteredEventIds();
                            fetchMyEvents();
                            fetchEvents();
                        } else {
                            showToast(
                                result.message || "Registration failed",
                                "error",
                            );
                        }
                    } catch (e) {
                        console.error(e);
                        const message =
                            e.response?.data?.message ||
                            "Error registering for event";
                        showToast(message, "error");
                    }
                }

                async function fetchMyEvents() {
                    const list = document.getElementById("myEventsList");
                    if (!list) return;

                    try {
                        const res = await api.get(
                            "/api/registration/my-registrations",
                        );
                        const { data } = res.data;

                        const now = new Date();
                        const upcomingEvents = data.filter(
                            (reg: any) => new Date(reg.event.date) >= now,
                        );

                        if (upcomingEvents.length === 0) {
                            list.innerHTML =
                                '<div class="col-span-full text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"><p class="text-gray-500 text-lg font-bold uppercase tracking-wide">You have no upcoming events.</p></div>';
                            return;
                        }

                        list.innerHTML = upcomingEvents
                            .map(
                                (reg: any) => `
                <div class="card bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] rounded-none hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all hover:-translate-y-1">
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-black text-lg text-gray-900 uppercase tracking-tight line-clamp-1">${reg.event.title}</h3>
                                <p class="text-sm text-gray-600 font-bold mt-1">${new Date(reg.event.date).toLocaleDateString()}</p>
                            </div>
                            <span class="badge ${reg.paymentStatus === "COMPLETED" ? "bg-green-500" : "bg-yellow-500"} text-white text-xs font-black border-2 border-black rounded-none uppercase tracking-wide">${reg.paymentStatus}</span>
                        </div>
                        <div class="mt-4 pt-4 border-t-2 border-gray-100 flex justify-between items-center">
                            <div class="text-xs text-gray-500 font-mono font-bold">ID: ${reg.ticketId}</div>
                            <div class="flex gap-2">
                                <button class="btn btn-ghost btn-xs text-gray-600 font-bold hover:bg-gray-100 rounded-none uppercase" onclick="openTicketModal('${reg.ticketId}', '${reg.event.title}', '${reg.event.date}', '${reg.event.venue}', '${reg.qrCodeUrl}', '${reg.user.firstName} ${reg.user.lastName}')">View Ticket</button>
                                <button class="btn btn-ghost btn-xs text-blue-600 font-bold hover:bg-blue-50 rounded-none uppercase" onclick="openEventModal('${reg.event.publicId}')">View Details</button>
                            </div>
                        </div>
                    </div>
                </div>
            `,
                            )
                            .join("");
                    } catch (e) {
                        console.error(e);
                        list.innerHTML =
                            '<div class="col-span-full text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"><p class="text-red-500 text-lg font-bold uppercase tracking-wide">Failed to load events.</p></div>';
                    }
                }

                async function fetchPastEvents() {
                    const list = document.getElementById("pastEventsList");
                    if (!list) return;

                    try {
                        const res = await api.get(
                            "/api/registration/my-registrations",
                        );
                        const { data } = res.data;

                        const now = new Date();
                        const pastEvents = data.filter(
                            (reg: any) => new Date(reg.event.date) < now,
                        );

                        if (pastEvents.length === 0) {
                            list.innerHTML =
                                '<div class="col-span-full text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"><p class="text-gray-500 text-lg font-bold uppercase tracking-wide">You have no past events.</p></div>';
                            return;
                        }

                        list.innerHTML = pastEvents
                            .map(
                                (reg: any) => `
                <div class="card bg-gray-100 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] rounded-none opacity-80 hover:opacity-100 transition-all">
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-black text-lg text-gray-900 uppercase tracking-tight line-clamp-1">${reg.event.title}</h3>
                                <p class="text-sm text-gray-600 font-bold mt-1">${new Date(reg.event.date).toLocaleDateString()}</p>
                            </div>
                            <span class="badge bg-gray-500 text-white text-xs font-black border-2 border-black rounded-none uppercase tracking-wide">COMPLETED</span>
                        </div>
                        <div class="mt-4 pt-4 border-t-2 border-gray-200 flex justify-between items-center">
                            <div class="text-xs text-gray-500 font-mono font-bold">ID: ${reg.ticketId}</div>
                            <div class="flex gap-2">
                                <button class="btn btn-ghost btn-xs text-gray-600 font-bold hover:bg-gray-100 rounded-none uppercase" onclick="openTicketModal('${reg.ticketId}', '${reg.event.title}', '${reg.event.date}', '${reg.event.venue}', '${reg.qrCodeUrl}', '${reg.user.firstName} ${reg.user.lastName}')">View Ticket</button>
                                <button class="btn btn-ghost btn-xs text-blue-600 font-bold hover:bg-blue-50 rounded-none uppercase" onclick="openEventModal('${reg.event.publicId}')">View Details</button>
                            </div>
                        </div>
                    </div>
                </div>
            `,
                            )
                            .join("");
                    } catch (e) {
                        console.error(e);
                        list.innerHTML =
                            '<div class="col-span-full text-center py-16 bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"><p class="text-red-500 text-lg font-bold uppercase tracking-wide">Failed to load past events.</p></div>';
                    }
                }

                let currentLayout = "grid";

                (window as any).toggleLayout = (layout) => {
                    currentLayout = layout;
                    const gridBtn = document.getElementById("gridViewBtn");
                    const listBtn = document.getElementById("listViewBtn");
                    const eventsGrid = document.getElementById("eventsGrid");

                    if (layout === "grid") {
                        gridBtn?.classList.add("active-layout");
                        listBtn?.classList.remove("active-layout");
                        eventsGrid?.classList.remove("grid-cols-1");
                        eventsGrid?.classList.add(
                            "md:grid-cols-2",
                            "lg:grid-cols-3",
                        );
                    } else {
                        listBtn?.classList.add("active-layout");
                        gridBtn?.classList.remove("active-layout");
                        eventsGrid?.classList.remove(
                            "md:grid-cols-2",
                            "lg:grid-cols-3",
                        );
                        eventsGrid?.classList.add("grid-cols-1");
                    }
                    fetchEvents();
                };

                const filterBtn = document.getElementById("filterBtn");
                filterBtn?.addEventListener("click", () => {
                    const search = (
                        document.getElementById(
                            "searchEvents",
                        ) as HTMLInputElement
                    ).value;
                    const category = (
                        document.getElementById(
                            "filterCategory",
                        ) as HTMLSelectElement
                    ).value;
                    const date = (
                        document.getElementById(
                            "filterDate",
                        ) as HTMLInputElement
                    ).value;
                    const venue = (
                        document.getElementById(
                            "filterVenue",
                        ) as HTMLSelectElement
                    ).value;

                    const params: any = {};
                    if (search) params.search = search;
                    if (category && category !== "Category")
                        params.category = category;
                    if (date) params.date = date;
                    if (venue && venue !== "Location") params.venue = venue;

                    fetchEvents(params);
                });

                fetchUserProfile();
                await fetchRegisteredEventIds();
                fetchEvents();

                window.openTicketModal = function (
                    ticketId,
                    eventTitle,
                    eventDate,
                    eventVenue,
                    qrCodeUrl,
                    attendeeName,
                ) {
                    const modal = document.getElementById(
                        "ticketModal",
                    ) as HTMLDialogElement | null;
                    if (!modal) return;

                    const titleEl = document.getElementById("ticketEventTitle");
                    if (titleEl) titleEl.textContent = eventTitle;

                    const dateEl = document.getElementById("ticketEventDate");
                    if (dateEl)
                        dateEl.textContent = new Date(
                            eventDate,
                        ).toLocaleString();

                    const venueEl = document.getElementById("ticketEventVenue");
                    if (venueEl) venueEl.textContent = eventVenue;

                    const attendeeEl =
                        document.getElementById("ticketAttendeeName");
                    if (attendeeEl) attendeeEl.textContent = attendeeName;

                    const idEl = document.getElementById("ticketIdDisplay");
                    if (idEl) idEl.textContent = `#${ticketId}`;

                    const qrImg = document.getElementById(
                        "ticketQRCode",
                    ) as HTMLImageElement | null;
                    if (qrImg)
                        qrImg.src =
                            qrCodeUrl ||
                            "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" +
                                ticketId;

                    modal.showModal();
                };
            });
        </script>

        <style>
            * {
                border-radius: 0 !important;
            }

            .btn,
            .card,
            .input,
            .select,
            .badge,
            .modal-box {
                border-radius: 0 !important;
            }

            .page-content {
                animation: fadeIn 0.3s ease-in;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .active-layout {
                background-color: rgb(243, 244, 246);
                color: rgb(37, 99, 235);
            }
        </style>
    </div>
</Layout>
