---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";

const url = new URL(Astro.request.url);
const tokenFromUrl = url.searchParams.get("token");

// Server-side redirect check
const cookie = Astro.request.headers.get("cookie") || "";
const hasToken = cookie.includes("token=") || tokenFromUrl;

if (!hasToken) {
  return Astro.redirect("/login");
}
---

<Layout title="CompleteProfile - EventEase">
  <Navbar />

  <main
    class="relative min-h-screen flex items-center justify-center p-8 bg-gradient-to-br from-[#e8f4ff] to-[#f0f9ff] overflow-hidden"
  >
    <div class="absolute top-0 left-0 right-0 bottom-0 overflow-hidden z-0">
      <div
        class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[500px] h-[500px] bg-gradient-to-br from-[#002ffe] to-[#000000] top-[-200px] right-[-200px]"
      >
      </div>
      <div
        class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[400px] h-[400px] bg-gradient-to-br from-[#0066ff] to-[#00ccff] bottom-[-150px] left-[-150px] delay-[5s]"
      >
      </div>
    </div>

    <div class="relative z-10 max-w-[1100px]">
      <div class="w-full max-w-2xl">
        <div class="flex items-center justify-center gap-8 mb-10">
          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-none border-2 border-black bg-black text-white font-bold transition-all duration-300"
              data-progress="1"
            >
              1
            </div>
            <span class="text-sm mt-2 text-gray-700 font-medium">Personal</span>
          </div>

          <div
            class="w-16 h-1 bg-gray-300 rounded-none transition-all duration-300"
            data-line="1"
          >
          </div>

          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-none border-2 border-gray-300 text-gray-500 font-bold transition-all duration-300"
              data-progress="2"
            >
              2
            </div>
            <span class="text-sm mt-2 text-gray-700 font-medium">Contact</span>
          </div>

          <div
            class="w-16 h-1 bg-gray-300 rounded-none transition-all duration-300"
            data-line="2"
          >
          </div>

          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-none border-2 border-gray-300 text-gray-500 font-bold transition-all duration-300"
              data-progress="3"
            >
              3
            </div>
            <span class="text-sm mt-2 text-gray-700 font-medium">Address</span>
          </div>
        </div>

        <div
          class="bg-white shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] rounded-none p-10 w-full transition-all duration-300 border-2 border-black"
        >
          <form id="multiStepForm" class="space-y-8">
            <div class="form-step space-y-10" data-step="1">
              <h2
                class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-3"
              >
                <span class="text-blue-600">Personal</span> Information
              </h2>

              <div class="space-y-6">
                <div>
                  <label
                    for="firstName"
                    class="text-sm font-semibold text-gray-700"
                    >First Name</label
                  >
                  <div class="relative">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <input
                      type="text"
                      id="firstName"
                      name="firstName"
                      placeholder="John"
                      required
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-white border-2 border-black
                      transition-all duration-300 focus:border-blue-500 my-3"
                    />
                  </div>
                </div>

                <div>
                  <label
                    for="lastName"
                    class="text-sm font-semibold text-gray-700">Last Name</label
                  >

                  <div class="relative">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <input
                      type="text"
                      id="lastName"
                      name="lastName"
                      placeholder="Doe"
                      required
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-white border-2 border-black
                      transition-all duration-300 focus:border-blue-500 my-3"
                    />
                  </div>
                </div>
              </div>

              <button
                type="button"
                class="w-full h-10 py-4 text-white font-bold text-md flex items-center justify-center gap-2
                    bg-black hover:bg-gray-800 transition-all duration-300 rounded-none cursor-pointer border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"
                id="nextStep1"
              >
                <span>Continue</span>
                <svg
                  class="w-5 h-5"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
              </button>
            </div>

            <div class="form-step hidden space-y-10" data-step="2">
              <h2
                class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-3"
              >
                <span class="text-blue-600">Contact</span> Information
              </h2>

              <div class="space-y-6">
                <div>
                  <label
                    for="phone"
                    class="block text-sm font-semibold text-gray-700 mb-1"
                    >Phone Number</label
                  >
                  <div class="relative mt-3">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2 4.18 2 2 0 0 1 4 2h3a2 2 0 0 1 2 1.72c.13.94.38 1.85.73 2.71a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.37-1.37a2 2 0 0 1 2.11-.45c.86.35 1.77.6 2.71.73a2 2 0 0 1 1.72 2z"
                      ></path>
                    </svg>
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-white border-2 border-black
                     transition-all duration-300 focus:border-blue-500"
                      placeholder="+1 234 567 890"
                      required
                      autocomplete="tel"
                    />
                  </div>
                </div>
              </div>

              <div class="flex justify-end mt-10 gap-2">
                <button
                  type="button"
                  class="w-full h-10 py-4 text-black font-bold text-md flex items-center justify-center gap-2
                    bg-white hover:bg-gray-100 transition-all duration-300 rounded-none cursor-pointer border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                  id="prevStep2"
                >
                  <span class="mr-2">←</span> Back
                </button>

                <button
                  type="button"
                  class="w-full h-10 py-4 text-white font-bold text-md flex items-center justify-center gap-2
                    bg-black hover:bg-gray-800 transition-all duration-300 rounded-none cursor-pointer border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"
                  id="nextStep2"
                >
                  Continue <span class="ml-2">→</span>
                </button>
              </div>
            </div>

            <div class="form-step hidden space-y-10" data-step="3">
              <h2
                class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-3"
              >
                <span class="text-blue-600">Account </span> Type
              </h2>
              <div class="gap-10">
                <label for="role" class="font-semibold text-sm text-gray-800"
                  >Account Type</label
                >
                <div class="space-y-6">
                  <div class="relative mt-3">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <select
                      id="role"
                      name="role"
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-white border-2 border-black
                     transition-all duration-300 focus:border-blue-500 cursor-pointer"
                      required
                    >
                      <option value="">Choose account type</option>
                      <option value="organizer">Event Organizer</option>
                      <option value="user">Event Attendee</option>
                      <option value="both">Both Organizer & Attendee</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="flex justify-end mt-10">
                <button
                  type="button"
                  class="w-full h-10 py-4 text-black font-bold text-md flex items-center justify-center gap-2
                    bg-white hover:bg-gray-100 transition-all duration-300 rounded-none cursor-pointer border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                  id="prevStep3"
                >
                  <span class="mr-2">←</span> Back
                </button>

                <button
                  type="submit"
                  class="w-full h-10 py-4 text-white font-bold text-md flex items-center justify-center gap-2
                    bg-green-600 hover:bg-green-700 transition-all duration-300 rounded-none cursor-pointer border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"
                >
                  <span class="mr-2">✓</span> Submit
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2">
</div>

<!-- Rest of your template remains the same -->

<script>
  import api from "../lib/api";
  import { checkAuth } from "../lib/auth";

  function handleOAuthToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    if (token) {
      document.cookie = `token=${token}; path=/; max-age=${30 * 60}; SameSite=Lax`;

      const userId = urlParams.get("userId");
      const newUrl = userId
        ? `${window.location.pathname}?userId=${userId}`
        : window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
    }
  }

  handleOAuthToken();

  // Check auth immediately
  (async () => {
    const user = await checkAuth();
    if (!user) {
      window.location.href = "/login";
    }
  })();

  const form = document.getElementById("multiStepForm");
  const steps = document.querySelectorAll(".form-step");
  const progressCircles = document.querySelectorAll("[data-progress]");
  const progressLines = document.querySelectorAll("[data-line]");
  let currentStep = 0;

  // Initialize the form
  function initForm() {
    // Show first step
    showStep(0);

    // Add event listeners
    document.getElementById("nextStep1")?.addEventListener("click", () => {
      if (validateStep(0)) showStep(1);
    });

    document.getElementById("nextStep2")?.addEventListener("click", () => {
      if (validateStep(1)) showStep(2);
    });

    document
      .getElementById("prevStep2")
      ?.addEventListener("click", () => showStep(0));
    document
      .getElementById("prevStep3")
      ?.addEventListener("click", () => showStep(1));

    form?.addEventListener("submit", handleSubmit);
  }

  function showStep(stepIndex) {
    // Hide all steps
    steps.forEach((step, index) => {
      step.classList.toggle("hidden", index !== stepIndex);
    });

    // Update progress indicators
    progressCircles.forEach((circle, index) => {
      circle.classList.toggle("bg-black", index <= stepIndex);
      circle.classList.toggle("text-white", index <= stepIndex);
      circle.classList.toggle("border-black", index <= stepIndex);
      circle.classList.toggle("text-gray-500", index > stepIndex);
      circle.classList.toggle("border-gray-300", index > stepIndex);
    });

    // Update progress lines
    progressLines.forEach((line, index) => {
      line.classList.toggle("bg-black", index < stepIndex);
      line.classList.toggle("bg-gray-300", index >= stepIndex);
    });

    currentStep = stepIndex;
  }

  function validateStep(stepIndex) {
    const currentFields = steps[stepIndex].querySelectorAll("[required]");
    let isValid = true;

    currentFields.forEach((field) => {
      const value = field.value.trim();
      const isEmpty = field.type === "checkbox" ? !field.checked : !value;

      if (isEmpty || (field.tagName === "SELECT" && value === "")) {
        isValid = false;
        field.style.border = "1px solid #ef4444";

        // Add error message if not already present
        if (!field.nextElementSibling?.classList?.contains("error-message")) {
          const errorMsg = document.createElement("p");
          errorMsg.className = "text-red-500 text-xs mt-1 error-message";
          errorMsg.textContent = "This field is required";
          field.parentNode?.insertBefore(errorMsg, field.nextSibling);
        }
      } else {
        field.style.border = "1px solid #d1d5db";
        // Remove error message if exists
        const errorMsg = field.nextElementSibling;
        if (errorMsg?.classList?.contains("error-message")) {
          errorMsg.remove();
        }
      }
    });

    return isValid;
  }

  // Toast notification function
  function showToast(message: string, type: "success" | "error" = "success") {
    const container = document.getElementById("toast-container");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = `p-4 rounded-none border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transform transition-all duration-300 ${
      type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
    } font-bold`;
    toast.textContent = message;

    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateX(400px)";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function storeToken(token: string, maxAge: number = 24 * 60 * 60) {
    document.cookie = `token=${token}; path=/; max-age=${maxAge}; SameSite=Lax`;
  }

  async function handleSubmit(e) {
    e.preventDefault();

    if (!validateStep(2)) {
      showToast("Please complete all required fields", "error");
      return;
    }

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    console.log("Submitting profile data:", data);

    try {
      const response = await api.post("/api/auth/local/complete-profile", {
        firstName: data.firstName,
        lastName: data.lastName,
        phone: data.phone || "",
        role: (data.role as string)?.toUpperCase() || "USER",
      });

      const result = response.data;
      console.log("Complete profile response:", result);

      if (result.token) {
        storeToken(result.token);
      }

      showToast(result.message || "Profile completed successfully!", "success");

      setTimeout(() => {
        const redirectUrl =
          result.user?.role === "ORGANIZER" || result.user?.role === "BOTH"
            ? "/organiser"
            : "/dashboard";
        console.log("Redirecting to:", redirectUrl);
        window.location.href = redirectUrl;
      }, 1500);
    } catch (error) {
      console.error("Complete profile error:", error);
      const message =
        error.response?.data?.message || "An error occurred. Please try again.";
      showToast(message, "error");
    }
  }

  // Initialize the form when the component mounts
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initForm);
  } else {
    initForm();
  }
</script>
